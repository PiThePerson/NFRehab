<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard | NeuronFRAMES</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-bg: linear-gradient(
          270deg,
          #3ce3a4 0%,
          #35d8ca 43%,
          #31d1e1 58%,
          #2fc9ff 100%
        );
        --primary-font: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        --primary-text: #1a1a1a;
        --secondary-text: #ffffff;
        --button-bg: #3b82f6;
        --button-bg-hover: #2563eb;
        --button-text: white;
        --border-radius: 0.5rem;
        --card-bg: rgba(255, 255, 255, 0.95);
        --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--primary-font);
        background: var(--primary-bg);
        color: var(--primary-text);
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
      }

      .container {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
      }

      /* Text Size Controls */
      .top-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        gap: 10px;
        z-index: 100;
      }

      .text-size-toggle {
        background: var(--card-bg);
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 101;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: var(--secondary-text);
        position: relative;
      }

      .header-title {
        font-size: 2.5rem;
        margin: 15px 0 5px;
        font-weight: 700;
      }

      .header-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        background: var(--card-bg);
        border-radius: var(--border-radius);
        color: var(--button-bg);
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        position: absolute;
        left: 0;
        top: 0;
      }

      .back-button:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .profile-card,
      .leaderboard-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: var(--card-shadow);
      }

      .profile-card {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
      }

      .profile-info,
      .session-stats {
        flex: 1;
        min-width: 250px;
      }

      .user-name {
        font-size: 1.8rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
      }

      .profile-info p,
      .session-stats p {
        margin-bottom: 12px;
        font-size: 1rem;
      }

      .session-stats strong {
        font-size: 1.1rem;
      }

      .leaderboard-card h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
        color: #2d3748;
      }

      .leaderboard-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 0.95rem;
      }

      .leaderboard-table th {
        background-color: #f8fafc;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        color: #4a5568;
        border-bottom: 2px solid #e2e8f0;
      }

      .leaderboard-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #edf2f7;
      }

      .leaderboard-table tr:last-child td {
        border-bottom: none;
      }

      .leaderboard-table tr:nth-child(1) {
        font-weight: bold;
        background-color: #fef9c3;
      }

      .leaderboard-table tr:nth-child(2) {
        background-color: #f3f4f6;
      }

      .leaderboard-table tr:nth-child(3) {
        background-color: #f9fafb;
      }

      .leaderboard-table tr.highlight {
        background-color: #ebf8ff;
        font-weight: 600;
      }

      /* Text size classes */
      .text-normal {
        --text-size: 1;
      }
      .text-large {
        --text-size: 1.5;
      }
      .text-xlarge {
        --text-size: 2;
      }

      /* Apply text size scaling to ALL text elements */
      body {
        font-size: calc(16px * var(--text-size, 1));
      }

      /* Specific scaling for larger elements */
      .header-title {
        font-size: calc(2.5rem * var(--text-size, 1));
      }

      .header-subtitle {
        font-size: calc(1.1rem * var(--text-size, 1));
      }

      .user-name {
        font-size: calc(1.8rem * var(--text-size, 1));
      }

      .leaderboard-card h2 {
        font-size: calc(1.5rem * var(--text-size, 1));
      }

      /* Scale all numbers and text in cards */
      .profile-info p,
      .session-stats p,
      .leaderboard-table,
      .leaderboard-table th,
      .leaderboard-table td,
      .profile-info span,
      .session-stats span,
      .profile-info strong,
      .session-stats strong {
        font-size: calc(1rem * var(--text-size, 1)) !important;
      }

      /* Scale back button and text size toggle */
      .back-button,
      .text-size-toggle {
        font-size: calc(0.9rem * var(--text-size, 1)) !important;
      }

      @media (max-width: 768px) {
        .header-title {
          font-size: calc(2rem * var(--text-size, 1));
        }

        .profile-card {
          flex-direction: column;
          gap: 20px;
        }

        .back-button {
          position: relative;
          margin-bottom: 15px;
        }

        .top-controls {
          position: relative;
          top: 0;
          left: 0;
          margin-bottom: 15px;
          justify-content: center;
        }
      }

      /* Add these styles to your existing CSS */
      .quests-container {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 25px;
        margin-top: 25px;
        box-shadow: var(--card-shadow);
      }

      .quest-item {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #0077ff;
        transition: all 0.3s ease;
      }

      .quest-item.completed {
        border-left-color: #3ce3a4;
        background-color: rgba(60, 227, 164, 0.1);
      }

      .quest-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .quest-title {
        font-weight: 600;
        font-size: 1.1rem;
        color: #2d3748;
      }

      .quest-reward {
        background-color: #ffd700;
        color: #8a6d00;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .quest-description {
        color: #4a5568;
        margin-bottom: 10px;
        font-size: 0.95rem;
      }

      .quest-progress {
        margin-top: 15px;
      }

      .progress-bar {
        height: 8px;
        background-color: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 5px;
      }

      .progress-fill {
        height: 100%;
        background: var(--primary-bg);
        width: 0%;
        transition: width 0.5s ease;
      }

      .progress-text {
        font-size: 0.85rem;
        text-align: right;
        color: #718096;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 25px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .modal h3 {
        color: #2d3748;
        margin-bottom: 20px;
        font-size: 1.3rem;
      }

      .close {
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 24px;
        color: #718096;
        cursor: pointer;
        transition: color 0.2s;
      }

      .close:hover {
        color: #2d3748;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #4a5568;
        font-size: 0.95rem;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #3182ce;
        box-shadow: 0 0 0 1px #3182ce;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 30px 0;
        color: #718096;
      }

      .empty-icon {
        font-size: 2rem;
        margin-bottom: 15px;
        color: #cbd5e0;
      }

      /* Responsive Adjustments */
      @media (max-width: 768px) {
        .modal-content {
          margin: 20% auto;
          padding: 20px;
        }

        .quests-container {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body class="text-normal">
    <div class="container">
      <!-- Text Size Controls -->
      <div class="top-controls">
        <button class="text-size-toggle" id="textSizeToggle">
          A+ Text Size
        </button>
      </div>

      <header class="header">
        <a href="dashboard.html" class="back-button">
          <i class="fas fa-arrow-left"></i>
          Back to Dashboard
        </a>
        <h1 class="header-title">Profile</h1>
        <p class="header-subtitle">See and compare your stats!</p>
      </header>

      <!-- Profile Section -->
      <div class="profile-card">
        <div class="profile-info">
          <h2 class="user-name">üë§ <span id="userName">User</span></h2>
          <p><strong>Age:</strong> <span id="userAge">-</span></p>
          <p><strong>Diagnosis:</strong> <span id="userDiagnosis">-</span></p>
          <p>
            <strong>Assigned Therapist:</strong>
            <span id="userTherapist" alt="Thanakorn I.">-</span>
          </p>
        </div>
        <div class="session-stats">
          <p>ü©∫ Sessions Completed: <strong id="userSessions">0</strong></p>
          <p>üåü Stars Earned: <strong id="userStars">0</strong></p>
          <p>üìÖ Last Session: <strong id="lastSession">-</strong></p>
        </div>
      </div>

      <!-- Add this section below your existing stats overview -->
      <div class="quests-container" style="margin-top: 30px">
        <div class="records-header">
          <h2 class="records-title">Your Therapy Goals</h2>
          <div class="filter-controls">
            <button id="addQuestBtn" class="filter-select">
              <i class="fas fa-plus"></i> Add Goal
            </button>
          </div>
        </div>

        <div id="questsList" class="divide-y divide-gray-100 divide-opacity-20">
          <!-- Quests will be loaded here -->
          <div class="empty-state">
            <i class="fas fa-flag empty-icon"></i>
            <p>No active goals. Add your first goal!</p>
          </div>
        </div>
      </div>

      <!-- Add this modal at the bottom of your body -->
      <div id="questModal" class="modal" style="display: none">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h3>Create New Goal</h3>
          <div class="form-group">
            <label for="questTitle">Goal Title</label>
            <input
              type="text"
              id="questTitle"
              placeholder="Complete 5 grip exercises"
            />
          </div>
          <div class="form-group">
            <label for="questType">Goal Type</label>
            <select id="questType" class="filter-select">
              <option value="grip">Normal Mode</option>
              <option value="game">Game Mode</option>
              <option value="normal">Grip Mode</option>
              <option value="speech">Speech Mode</option>
            </select>
          </div>
          <div class="form-group">
            <label for="questTarget">Target (sessions or score)</label>
            <input type="number" id="questTarget" placeholder="5" min="1" />
          </div>
          <div class="form-group">
            <label for="questReward">Stars Reward</label>
            <input type="number" id="questReward" placeholder="10" min="1" />
          </div>
          <button
            id="saveQuestBtn"
            class="filter-select"
            style="margin-top: 15px"
          >
            <i class="fas fa-save"></i> Save Quest
          </button>
        </div>
      </div>
      <br />

      <!-- Leaderboard Section -->
      <div class="leaderboard-card">
        <h2>üèÜ Leaderboard</h2>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>User</th>
              <th>Stars</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <!-- Leaderboard will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      /* ===== TEXT SIZE FUNCTIONS ===== */
      function toggleTextSize() {
        const body = document.body;
        const currentSize = localStorage.getItem("nf_textSize") || "normal";
        const textSizeToggle = document.getElementById("textSizeToggle");

        let newSize, newLabel;
        switch (currentSize) {
          case "normal":
            newSize = "large";
            body.className = "text-large";
            newLabel = "A++ Text Size";
            break;
          case "large":
            newSize = "xlarge";
            body.className = "text-xlarge";
            newLabel = "A (Reset)";
            break;
          default:
            newSize = "normal";
            body.className = "text-normal";
            newLabel = "A+ Text Size";
        }

        localStorage.setItem("nf_textSize", newSize);
        textSizeToggle.textContent = newLabel;
      }

      function initTextSize() {
        const savedSize = localStorage.getItem("nf_textSize") || "normal";
        const body = document.body;
        const textSizeToggle = document.getElementById("textSizeToggle");

        switch (savedSize) {
          case "large":
            body.className = "text-large";
            textSizeToggle.textContent = "A++ Text Size";
            break;
          case "xlarge":
            body.className = "text-xlarge";
            textSizeToggle.textContent = "A (Reset)";
            break;
          default:
            body.className = "text-normal";
            textSizeToggle.textContent = "A+ Text Size";
        }
      }

      /* ===== USER DATA ===== */
      const users = JSON.parse(localStorage.getItem("nf_users") || "{}");
      const currentUser = localStorage.getItem("nf_loggedInUser");

      if (!currentUser || !users[currentUser]) {
        window.location.href = "../index.html";
      }

      const user = users[currentUser];
      document.getElementById("userName").textContent =
        user.fullName || currentUser;
      document.getElementById("userAge").textContent = user.age || "-";
      document.getElementById("userDiagnosis").textContent =
        user.diagnosis || "-";
      document.getElementById("userTherapist").textContent =
        user.therapist || "-";
      document.getElementById("userSessions").textContent = user.therapy || 0;
      document.getElementById("userStars").textContent = user.stars || 0;
      document.getElementById("lastSession").textContent =
        user.lastSession || "-";

      // Sample leaderboard data including the current user
      const leaderboardData = [
        { username: "ILoveStars", fullName: "üåü ILoveStars", stars: 3120 },
        { username: "StrokeSlayer", fullName: "üí™ StrokeSlayer", stars: 2890 },
        {
          username: "FastRecovery123",
          fullName: "üèÉ‚Äç‚ôÄÔ∏è FastRecovery123",
          stars: 2560,
        },
        { username: "WheelWarrior", fullName: "üë®‚Äçü¶Ω WheelWarrior", stars: 2120 },
        { username: "GripMaster", fullName: "üñêÔ∏è GripMaster", stars: 1890 },
        {
          username: currentUser,
          fullName: user.fullName || currentUser,
          stars: user.stars || 0,
          isCurrentUser: true,
        },
      ];

      // Sort by stars (descending)
      const sortedLeaderboard = leaderboardData.sort(
        (a, b) => b.stars - a.stars
      );

      // Populate the leaderboard
      const leaderboardBody = document.getElementById("leaderboardBody");
      if (leaderboardBody) {
        leaderboardBody.innerHTML = sortedLeaderboard
          .map(
            (user, index) => `
            <tr${user.isCurrentUser ? ' class="highlight"' : ""}>
              <td>${index + 1}</td>
              <td>${user.fullName}</td>
              <td>${user.stars}</td>
            </tr>
          `
          )
          .join("");
      }

      /* ===== INITIALIZATION ===== */
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize text size
        initTextSize();

        // Add event listener for text size toggle
        document
          .getElementById("textSizeToggle")
          .addEventListener("click", toggleTextSize);
      });

      // ===== QUEST SYSTEM =====
      // Initialize quest system when page loads
      document.addEventListener("DOMContentLoaded", () => {
        initQuests();
        setupQuestModal();

        // Check for quest completion whenever sessions are updated
        const originalSaveFn = localStorage.setItem;
        localStorage.setItem = function (key, value) {
          originalSaveFn.apply(this, arguments);
          if (key === "therapySessions") {
            checkQuestCompletion();
          }
        };
      });

      // Quest System Functions
      function initQuests() {
        // Load quests from localStorage
        const savedQuests = localStorage.getItem("therapyQuests");
        const quests = savedQuests ? JSON.parse(savedQuests) : [];

        // Load completed quests
        const savedCompleted = localStorage.getItem("completedQuests");
        const completedQuests = savedCompleted
          ? JSON.parse(savedCompleted)
          : [];

        renderQuests(quests, completedQuests);
        checkQuestCompletion();
      }

      function renderQuests(quests, completedQuests) {
        const questsList = document.getElementById("questsList");

        if (!questsList) return;

        if (quests.length === 0) {
          questsList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-flag empty-icon"></i>
          <p>No active quests. Add your first quest!</p>
        </div>`;
          return;
        }

        questsList.innerHTML = quests
          .map((quest) => {
            const isCompleted = completedQuests.some((q) => q.id === quest.id);
            const progress = calculateQuestProgress(quest);

            return `
        <div class="quest-item ${isCompleted ? "completed" : ""}" data-id="${
              quest.id
            }">
          <div class="quest-header">
            <div class="quest-title">${quest.title}</div>
            <div class="quest-reward">‚òÖ ${quest.reward}</div>
          </div>
          <div class="quest-description">
            Complete ${quest.target} ${getModeName(quest.type)} sessions
          </div>
          <div class="quest-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${
                progress.percentage
              }%"></div>
            </div>
            <div class="progress-text">${progress.completed}/${
              quest.target
            } completed</div>
          </div>
        </div>
      `;
          })
          .join("");
      }

      function calculateQuestProgress(quest) {
        const sessions =
          JSON.parse(localStorage.getItem("therapySessions")) || [];
        const relevantSessions = sessions.filter((s) => s.mode === quest.type);

        // For grip mode, we might track score instead of count
        if (quest.type === "grip" && quest.target > 10) {
          const totalScore = relevantSessions.reduce(
            (sum, s) => sum + (s.score || 0),
            0
          );
          return {
            completed: Math.min(totalScore, quest.target),
            percentage: Math.min(100, (totalScore / quest.target) * 100),
          };
        }

        return {
          completed: Math.min(relevantSessions.length, quest.target),
          percentage: Math.min(
            100,
            (relevantSessions.length / quest.target) * 100
          ),
        };
      }

      function checkQuestCompletion() {
        const quests = JSON.parse(localStorage.getItem("therapyQuests")) || [];
        const completedQuests =
          JSON.parse(localStorage.getItem("completedQuests")) || [];
        const sessions =
          JSON.parse(localStorage.getItem("therapySessions")) || [];

        let newCompletions = [];
        let starsEarned = 0;

        quests.forEach((quest) => {
          // Skip if already completed
          if (completedQuests.some((q) => q.id === quest.id)) return;

          const progress = calculateQuestProgress(quest);

          if (progress.completed >= quest.target) {
            newCompletions.push(quest);
            starsEarned += quest.reward;

            // Show completion alert
            setTimeout(() => {
              alert(
                `üéâ Quest Completed!\n"${quest.title}"\nYou earned ${quest.reward} stars!`
              );
            }, 500);
          }
        });

        if (newCompletions.length > 0) {
          // Update completed quests
          const updatedCompleted = [...completedQuests, ...newCompletions];
          localStorage.setItem(
            "completedQuests",
            JSON.stringify(updatedCompleted)
          );

          // Update user stars
          updateUserStars(starsEarned);

          // Re-render quests
          renderQuests(quests, updatedCompleted);
        }
      }

      function updateUserStars(starsToAdd) {
        const users = JSON.parse(localStorage.getItem("nf_users")) || {};
        const currentUser = localStorage.getItem("nf_loggedInUser");
        if (currentUser && users[currentUser]) {
          users[currentUser].stars =
            (users[currentUser].stars || 0) + starsToAdd;
          localStorage.setItem("nf_users", JSON.stringify(users));

          // Update leaderboard if on profile page
          if (document.getElementById("userStars")) {
            document.getElementById("userStars").textContent =
              users[currentUser].stars;
          }
        }
      }

      function getModeName(mode) {
        const modes = {
          grip: "Grip",
          game: "Game",
          normal: "Normal",
          speech: "Speech",
        };
        return modes[mode] || mode;
      }

      // Modal and Quest Creation
      function setupQuestModal() {
        const modal = document.getElementById("questModal");
        const btn = document.getElementById("addQuestBtn");
        const span = document.getElementsByClassName("close")[0];
        const saveBtn = document.getElementById("saveQuestBtn");

        if (!modal || !btn) return;

        btn.onclick = function () {
          modal.style.display = "block";
        };

        span.onclick = function () {
          modal.style.display = "none";
        };

        saveBtn.onclick = function () {
          const title = document.getElementById("questTitle").value;
          const type = document.getElementById("questType").value;
          const target = parseInt(document.getElementById("questTarget").value);
          const reward = parseInt(document.getElementById("questReward").value);

          if (!title || isNaN(target) || isNaN(reward)) {
            alert("Please fill all fields with valid values");
            return;
          }

          const newQuest = {
            id: Date.now().toString(),
            title,
            type,
            target,
            reward,
            createdAt: new Date().toISOString(),
          };

          const quests =
            JSON.parse(localStorage.getItem("therapyQuests")) || [];
          quests.push(newQuest);
          localStorage.setItem("therapyQuests", JSON.stringify(quests));

          modal.style.display = "none";
          renderQuests(
            quests,
            JSON.parse(localStorage.getItem("completedQuests")) || []
          );

          // Clear form
          document.getElementById("questTitle").value = "";
          document.getElementById("questTarget").value = "";
          document.getElementById("questReward").value = "";
        };

        window.onclick = function (event) {
          if (event.target == modal) {
            modal.style.display = "none";
          }
        };
      }

      // ===== ORIGINAL SESSION RECORDS CODE =====
      // (Keep all your existing functions below this point)
      // DOM elements
      const recordsContainer = document.getElementById("recordsContainer");
      const filterMode = document.getElementById("filterMode");
      const sortDateBtn = document.getElementById("sortDateBtn");

      // Stats elements
      const totalSessionsEl = document.getElementById("totalSessions");
      const bestScoreEl = document.getElementById("bestScore");
      const recentModeEl = document.getElementById("recentMode");
      const avgDurationEl = document.getElementById("avgDuration");

      document
        .getElementById("exportCsvBtn")
        .addEventListener("click", exportToCSV);

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        const saved = localStorage.getItem("therapySessions");
        let sessions = [];

        if (saved) {
          sessions = JSON.parse(saved);

          /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MIGRATION / RENAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
          let patched = false;
          sessions.forEach((s) => {
            // map each known game to its mode-name label
            if (s.game === "Flappy Bird" || s.game === "Grip Therapy") {
              s.game = "Grip Mode";
              s.mode = "grip";
              patched = true;
            }
            if (s.game === "Squat Tracker") {
              s.game = "Normal Mode";
              s.mode = "normal";
              patched = true;
            }
            if (s.game === "Memory Match") {
              s.game = "Game Mode";
              s.mode = "game";
              patched = true;
            }
            if (s.game === "Speech Therapy") {
              s.game = "Speech Mode";
              s.mode = "speech";
              patched = true;
            }
          });
          if (patched) {
            localStorage.setItem("therapySessions", JSON.stringify(sessions));
          }
          /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

          sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        renderSessions(sessions);
        updateStats(sessions);
      });

      // Event listeners
      filterMode.addEventListener("change", () => {
        const stored = localStorage.getItem("therapySessions");
        const sessions = stored ? JSON.parse(stored) : [];
        renderSessions(sessions);
      });

      sortDateBtn.addEventListener("click", () => {
        const stored = localStorage.getItem("therapySessions");
        let sessions = [];

        if (stored) {
          sessions = JSON.parse(stored);
          if (sortDateBtn.dataset.sort === "desc") {
            sessions.sort((a, b) => new Date(a.date) - new Date(b.date));
            sortDateBtn.dataset.sort = "asc";
            sortDateBtn.innerHTML =
              '<i class="fas fa-sort-amount-up"></i> Date';
          } else {
            sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
            sortDateBtn.dataset.sort = "desc";
            sortDateBtn.innerHTML =
              '<i class="fas fa-sort-amount-down"></i> Date';
          }
          renderSessions(sessions);
        }
      });

      // Render sessions
      function renderSessions(sessions) {
        const filterValue = filterMode.value;
        let filteredSessions = sessions;

        if (filterValue !== "all") {
          filteredSessions = sessions.filter(
            (session) => session.mode === filterValue
          );
        }

        if (filteredSessions.length === 0) {
          recordsContainer.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-search empty-icon"></i>
              <p>No sessions found for this filter.</p>
            </div>`;
          return;
        }

        recordsContainer.innerHTML = filteredSessions
          .map(
            (session) => `
  <div class="record-item">
    <div class="record-content">
      <div class="record-info">
        <div class="record-icon ${getModeClass(session.mode)}">
          ${getModeIcon(session.mode)}
        </div>
        <div class="record-details">
          <h3>${session.game}</h3>
          <div class="record-meta">
            <span class="record-mode ${getModeClass(session.mode)}">
              ${capitalizeFirstLetter(session.mode)} Mode
            </span>
            ${
              session.difficulty
                ? `<span class="record-difficulty">${capitalizeFirstLetter(
                    session.difficulty
                  )}</span>`
                : ""
            }
            ${
              session.duration
                ? `<span>${formatDuration(session.duration)}</span>`
                : ""
            }
          </div>
        </div>
      </div>
      <div class="record-stats">
        <p class="record-date">${formatDate(session.date)}</p>
        ${
          session.score
            ? `<p class="record-score">Score: ${session.score}</p>`
            : ""
        }
      </div>
    </div>
  </div>
  `
          )
          .join("");
      }

      // Update stats - MODIFIED TO MATCH YOUR REFERENCE CODE
      function updateStats(sessions) {
        totalSessionsEl.textContent = sessions.length;

        if (sessions.length > 0) {
          // Best score (Grip Mode) or longest duration (others)
          const gripSessions = sessions.filter((s) => s.mode === "grip");
          const otherSessions = sessions.filter((s) => s.mode !== "grip");

          const bestGripScore =
            gripSessions.length > 0
              ? Math.max(...gripSessions.map((s) => s.score || 0))
              : 0;

          const bestDuration =
            otherSessions.length > 0
              ? Math.max(...otherSessions.map((s) => s.duration || 0))
              : 0;

          bestScoreEl.textContent =
            bestGripScore > 0
              ? bestGripScore
              : `${formatDuration(bestDuration)}`;

          // Recent mode
          recentModeEl.textContent =
            sessions[0].game || capitalizeFirstLetter(sessions[0].mode);

          // Average duration
          const totalDuration = sessions.reduce(
            (sum, s) => sum + (s.duration || 0),
            0
          );
          avgDurationEl.textContent = formatDuration(
            Math.round(totalDuration / sessions.length)
          );
        } else {
          bestScoreEl.textContent = "0";
          recentModeEl.textContent = "-";
          avgDurationEl.textContent = "0m";
        }
      }

      // Helper functions
      function capitalizeFirstLetter(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      function formatDate(dateString) {
        const opts = { year: "numeric", month: "short", day: "numeric" };
        return new Date(dateString).toLocaleDateString(undefined, opts);
      }

      function getModeClass(mode) {
        return `mode-${mode}`;
      }

      function getModeIcon(mode) {
        const icons = {
          grip: '<i class="fas fa-hand-paper"></i>',
          game: '<i class="fas fa-gamepad"></i>',
          normal: '<i class="fas fa-heartbeat"></i>',
          speech: '<i class="fas fa-comment-dots"></i>',
        };
        return icons[mode] || '<i class="fas fa-question"></i>';
      }

      function formatDuration(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        if (m === 0) return `${s}s`;
        if (s === 0) return `${m}m`;
        return `${m}m ${s}s`;
      }

      function exportToCSV() {
        // Get saved sessions from localStorage
        const sessions =
          JSON.parse(localStorage.getItem("therapySessions")) || [];

        // If no sessions, show an alert
        if (sessions.length === 0) {
          alert("No session data to export!");
          return;
        }

        // Create CSV header row
        let csv = "Date,Mode,Game,Score,Duration (s)\n";

        // Add each session as a row in the CSV
        sessions.forEach((session) => {
          csv += `"${session.date}","${session.mode}","${session.game}","${
            session.score || ""
          }","${session.duration || ""}"\n`;
        });

        // Create a downloadable file
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "therapy_sessions.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Replace with your Google Apps Script URL
      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbxSBv2TnS0PyRGj4KLKeIW8DCP05lCko0v-MFE5bRChrGtLaW5pz41nPJ8vI0MkeO4XBQ/exec";

      async function syncToGoogleSheets() {
        const sessions =
          JSON.parse(localStorage.getItem("therapySessions")) || [];

        if (sessions.length === 0) {
          alert("No sessions to sync!");
          return;
        }

        try {
          // First, open the auth window
          const authWindow = window.open(
            `${WEB_APP_URL}?auth=true`,
            "_blank",
            "width=500,height=600"
          );

          // Then send data after a short delay (to allow auth)
          setTimeout(async () => {
            for (const session of sessions) {
              const response = await fetch(
                `${WEB_APP_URL}?nocache=${Date.now()}`,
                {
                  method: "POST",
                  mode: "no-cors", // Important for CORS
                  body: JSON.stringify(session),
                  headers: { "Content-Type": "application/json" },
                }
              );
              console.log("Response:", response);
            }
            alert("Data synced to Google Sheets!");
            if (authWindow) authWindow.close();
          }, 2000);
        } catch (error) {
          console.error("Error:", error);
          alert("Error syncing: " + error.message);
        }
      }

      document
        .getElementById("testConnectionBtn")
        .addEventListener("click", async () => {
          try {
            const response = await fetch(`${WEB_APP_URL}?test=true`);
            const result = await response.text();
            alert("Connection successful! Response: " + result);
          } catch (error) {
            alert("Connection failed: " + error.message);
          }
        });

      // Add event listener for the sync button
      document
        .getElementById("syncSheetsBtn")
        .addEventListener("click", syncToGoogleSheets);
    </script>
  </body>
</html>
