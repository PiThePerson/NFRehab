<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Session History</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          270deg,
          #3ce3a4 0%,
          #35d8ca 43%,
          #31d1e1 58%,
          #2fc9ff 100%
        );
        color: #333;
        height: 100vh;
        overflow: hidden;
      }

      .scroll-container {
        height: 100vh;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding-bottom: 40px;
      }

      .graph-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        height: 300px;
        position: relative;
      }

      .graph-title {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.2rem;
        color: black;
      }

      .mode-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .mode-icon {
        font-size: 1.5rem;
        margin-right: 10px;
        color: #4dabf7;
      }

      .back-button {
        display: inline-flex;
        align-items: center;
        color: #4dabf7;
        text-decoration: none;
        margin-bottom: 20px;
        font-weight: 500;
        transition: all 0.2s;
      }

      .back-button:hover {
        color: #3d8fd6;
        transform: translateX(-2px);
      }

      .back-button i {
        margin-right: 8px;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: black;
        background: white;
        border-radius: 12px;
      }

      .graph-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
      }

      .graph-wrapper {
        flex: 1;
        min-width: calc(50% - 20px);
      }

      .chart-legend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 15px;
        color: black;
      }

      .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: black;
      }

      .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 3px;
        margin-right: 8px;
      }

      canvas {
        width: 100% !important;
        height: 100% !important;
      }

      .date-range {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.9);
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        color: #555;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .section-header {
        color: white;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
      }

      @media (max-width: 768px) {
        .scroll-container {
          padding: 15px;
        }

        .graph-wrapper {
          min-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="scroll-container">
      <div class="container">
        <a href="sessions1.html" class="back-button">
          <i class="fas fa-arrow-left"></i>
          Back to Sessions
        </a>

        <div class="mode-header">
          <div class="mode-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <h1 id="modeTitle">Daily Progress Analytics</h1>
        </div>

        <!-- Star Points Overview -->
        <div id="starsOverviewView">
          <h2 class="section-header">
            <i class="fas fa-star" style="margin-right: 10px"></i>
            Star Points Overview
          </h2>
          <div class="graph-row">
            <div class="graph-wrapper">
              <div class="graph-container">
                <div class="date-range" id="starsDateRange"></div>
                <h3 class="graph-title">Total Stars Earned Per Day</h3>
                <canvas id="starsChart"></canvas>
                <div class="chart-legend">
                  <div class="legend-item">
                    <span
                      class="legend-color"
                      style="background: rgba(255, 215, 0, 1)"
                    ></span>
                    <span>Daily Stars</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Grip Mode Graph -->
        <div id="gripModeView">
          <h2 class="section-header">
            <i class="fas fa-hand-paper" style="margin-right: 10px"></i>
            Grip Mode Analytics
          </h2>
          <div class="graph-row">
            <div class="graph-wrapper">
              <div class="graph-container">
                <div class="date-range" id="gripDateRange"></div>
                <h3 class="graph-title">Average Points Per Day</h3>
                <canvas id="gripPointsChart"></canvas>
                <div class="chart-legend">
                  <div class="legend-item">
                    <span
                      class="legend-color"
                      style="background: rgba(255, 99, 132, 1)"
                    ></span>
                    <span>Daily Average</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- EPT (Normal Mode) Graph -->
        <div id="normalModeView">
          <h2 class="section-header">
            <i class="fas fa-heartbeat" style="margin-right: 10px"></i>
            Normal Mode (EPT)
          </h2>
          <div class="graph-row">
            <div class="graph-wrapper">
              <div class="graph-container">
                <div class="date-range" id="squatDateRange"></div>
                <h3 class="graph-title">Squats Per Day</h3>
                <canvas id="squatCountChart"></canvas>
                <div class="chart-legend">
                  <div class="legend-item">
                    <span
                      class="legend-color"
                      style="background: rgba(54, 162, 235, 1)"
                    ></span>
                    <span>Daily Count</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- GPT (Game Mode) Graph -->
        <div id="gameModeView">
          <h2 class="section-header">
            <i class="fas fa-gamepad" style="margin-right: 10px"></i>
            Game Mode (GPT)
          </h2>
          <div class="graph-row">
            <div class="graph-wrapper">
              <div class="graph-container">
                <div class="date-range" id="gameDateRange"></div>
                <h3 class="graph-title">Average Score Per Day</h3>
                <canvas id="gameScoreChart"></canvas>
                <div class="chart-legend">
                  <div class="legend-item">
                    <span
                      class="legend-color"
                      style="background: rgba(255, 159, 64, 1)"
                    ></span>
                    <span>Daily Average</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SIT (Speech Mode) Graph -->
        <div id="speechModeView">
          <h2 class="section-header">
            <i class="fas fa-comment-dots" style="margin-right: 10px"></i>
            Speech Mode (SIT)
          </h2>
          <div class="graph-row">
            <div class="graph-wrapper">
              <div class="graph-container">
                <div class="date-range" id="speechDateRange"></div>
                <h3 class="graph-title">Levels Achieved Per Day</h3>
                <canvas id="speechLevelChart"></canvas>
                <div class="chart-legend">
                  <div class="legend-item">
                    <span
                      class="legend-color"
                      style="background: rgba(54, 162, 235, 1)"
                    ></span>
                    <span>Daily Count</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="noDataView" class="no-data" style="display: none">
          <i
            class="fas fa-chart-pie"
            style="font-size: 3rem; margin-bottom: 15px; color: #4dabf7"
          ></i>
          <p>No session data available yet.</p>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const saved = localStorage.getItem("therapySessions");
        let sessions = saved ? JSON.parse(saved) : [];

        if (sessions.length === 0) {
          document.getElementById("noDataView").style.display = "block";
          document.getElementById("starsOverviewView").style.display = "none";
          document.getElementById("gripModeView").style.display = "none";
          document.getElementById("normalModeView").style.display = "none";
          document.getElementById("gameModeView").style.display = "none";
          document.getElementById("speechModeView").style.display = "none";
          return;
        }

        // Group sessions by date and mode
        const sessionsByDate = {};
        sessions.forEach((session) => {
          const date = new Date(session.date).toLocaleDateString();
          if (!sessionsByDate[date]) {
            sessionsByDate[date] = {};
          }
          if (!sessionsByDate[date][session.mode]) {
            sessionsByDate[date][session.mode] = [];
          }
          sessionsByDate[date][session.mode].push(session);
        });

        // Calculate daily statistics
        const dailyStats = {};
        Object.keys(sessionsByDate).forEach((date) => {
          dailyStats[date] = {};

          // Star Points (total across all modes)
          const allSessions = [];
          Object.values(sessionsByDate[date]).forEach((modeSessions) => {
            allSessions.push(...modeSessions);
          });
          dailyStats[date].stars = {
            total: allSessions.reduce(
              (sum, session) => sum + (session.score || 0),
              0
            ),
          };

          // Grip Mode
          if (sessionsByDate[date].grip) {
            const gripSessions = sessionsByDate[date].grip;
            dailyStats[date].grip = {
              score: average(gripSessions.map((s) => s.score || 0)),
            };
          }

          // Normal Mode (EPT) - Squats
          if (sessionsByDate[date].normal) {
            const normalSessions = sessionsByDate[date].normal;
            dailyStats[date].normal = {
              count: normalSessions.reduce(
                (sum, session) => sum + (session.squatCount || 1),
                0
              ),
            };
          }

          // Game Mode (GPT)
          if (sessionsByDate[date].game) {
            const gameSessions = sessionsByDate[date].game;
            dailyStats[date].game = {
              score: average(gameSessions.map((s) => s.score || 0)),
            };
          }

          // Speech Mode (SIT)
          if (sessionsByDate[date].speech) {
            const speechSessions = sessionsByDate[date].speech;
            dailyStats[date].speech = {
              count: speechSessions.reduce(
                (sum, session) => sum + (session.levels || 1),
                0
              ),
            };
          }
        });

        // Sort dates chronologically
        const sortedDates = Object.keys(dailyStats).sort(
          (a, b) => new Date(a) - new Date(b)
        );

        // Update date range displays
        updateDateRangeDisplays(sortedDates);

        // Render all graphs
        renderStarsChart(sortedDates, dailyStats);
        renderGripModeChart(sortedDates, dailyStats);
        renderNormalModeChart(sortedDates, dailyStats);
        renderGameModeChart(sortedDates, dailyStats);
        renderSpeechModeChart(sortedDates, dailyStats);

        function average(arr) {
          if (arr.length === 0) return 0;
          const sum = arr.reduce((sum, val) => sum + val, 0);
          return parseFloat((sum / arr.length).toFixed(2));
        }

        function updateDateRangeDisplays(dates) {
          if (dates.length === 0) return;

          const formatDate = (dateStr) => {
            const date = new Date(dateStr);
            return date.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            });
          };

          const firstDate = formatDate(dates[0]);
          const lastDate = formatDate(dates[dates.length - 1]);

          document.getElementById(
            "starsDateRange"
          ).textContent = `${firstDate} - ${lastDate}`;
          document.getElementById(
            "gripDateRange"
          ).textContent = `${firstDate} - ${lastDate}`;
          document.getElementById(
            "squatDateRange"
          ).textContent = `${firstDate} - ${lastDate}`;
          document.getElementById(
            "gameDateRange"
          ).textContent = `${firstDate} - ${lastDate}`;
          document.getElementById(
            "speechDateRange"
          ).textContent = `${firstDate} - ${lastDate}`;
        }

        function renderStarsChart(dates, data) {
          const ctx = document.getElementById("starsChart").getContext("2d");
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: dates.map((date) =>
                new Date(date).toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                })
              ),
              datasets: [
                {
                  label: "Stars Earned",
                  data: dates.map((date) => data[date].stars?.total || 0),
                  backgroundColor: "rgba(255, 215, 0, 0.7)",
                  borderColor: "rgba(255, 215, 0, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              ...getChartOptions("Total Stars"),
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });
        }

        function renderGripModeChart(dates, data) {
          const ctx = document
            .getElementById("gripPointsChart")
            .getContext("2d");
          new Chart(ctx, {
            type: "line",
            data: {
              labels: dates.map((date) =>
                new Date(date).toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                })
              ),
              datasets: [
                {
                  label: "Average Points",
                  data: dates.map((date) => data[date].grip?.score || 0),
                  borderColor: "rgba(255, 99, 132, 1)",
                  backgroundColor: "rgba(255, 99, 132, 0.2)",
                  borderWidth: 2,
                  tension: 0.3,
                  fill: true,
                  pointBackgroundColor: "rgba(255, 99, 132, 1)",
                  pointBorderColor: "#fff",
                  pointRadius: 5,
                  pointHoverRadius: 8,
                  pointHitRadius: 10,
                  showLine: true,
                },
              ],
            },
            options: {
              ...getChartOptions("Average Points"),
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `Average Points: ${context.parsed.y}`;
                    },
                  },
                },
              },
            },
          });
        }

        function renderNormalModeChart(dates, data) {
          const squatCountCtx = document
            .getElementById("squatCountChart")
            .getContext("2d");
          new Chart(squatCountCtx, {
            type: "line",
            data: {
              labels: dates.map((date) =>
                new Date(date).toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                })
              ),
              datasets: [
                {
                  label: "Squats Per Day",
                  data: dates.map((date) => data[date].normal?.count || 0),
                  borderColor: "rgba(54, 162, 235, 1)",
                  backgroundColor: "rgba(54, 162, 235, 0.2)",
                  borderWidth: 2,
                  tension: 0.3,
                  fill: true,
                  pointBackgroundColor: "rgba(54, 162, 235, 1)",
                  pointBorderColor: "#fff",
                  pointRadius: 5,
                  pointHoverRadius: 8,
                  pointHitRadius: 10,
                  showLine: true,
                },
              ],
            },
            options: getChartOptions("Number of Squats"),
          });
        }

        function renderGameModeChart(dates, data) {
          const gameScoreCtx = document
            .getElementById("gameScoreChart")
            .getContext("2d");
          new Chart(gameScoreCtx, {
            type: "line",
            data: {
              labels: dates.map((date) =>
                new Date(date).toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                })
              ),
              datasets: [
                {
                  label: "Average Score",
                  data: dates.map((date) => data[date].game?.score || 0),
                  borderColor: "rgba(255, 159, 64, 1)",
                  backgroundColor: "rgba(255, 159, 64, 0.2)",
                  borderWidth: 2,
                  tension: 0.3,
                  fill: true,
                  pointBackgroundColor: "rgba(255, 159, 64, 1)",
                  pointBorderColor: "#fff",
                  pointRadius: 5,
                  pointHoverRadius: 8,
                  pointHitRadius: 10,
                  showLine: true,
                },
              ],
            },
            options: {
              ...getChartOptions("Average Score"),
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return `Average Score: ${context.parsed.y}`;
                    },
                  },
                },
              },
            },
          });
        }

        function renderSpeechModeChart(dates, data) {
          const speechLevelCtx = document
            .getElementById("speechLevelChart")
            .getContext("2d");
          new Chart(speechLevelCtx, {
            type: "line",
            data: {
              labels: dates.map((date) =>
                new Date(date).toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                })
              ),
              datasets: [
                {
                  label: "Levels Achieved",
                  data: dates.map((date) => data[date].speech?.count || 0),
                  borderColor: "rgba(54, 162, 235, 1)",
                  backgroundColor: "rgba(54, 162, 235, 0.2)",
                  borderWidth: 2,
                  tension: 0.3,
                  fill: true,
                  pointBackgroundColor: "rgba(54, 162, 235, 1)",
                  pointBorderColor: "#fff",
                  pointRadius: 5,
                  pointHoverRadius: 8,
                  pointHitRadius: 10,
                  showLine: true,
                },
              ],
            },
            options: getChartOptions("Levels Achieved"),
          });
        }

        function getChartOptions(yAxisTitle, maxY = null) {
          return {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: "index" },
            color: "#000",
            font: { family: "'Segoe UI', sans-serif" },
            scales: {
              y: {
                beginAtZero: true,
                max: maxY,
                title: {
                  display: true,
                  text: yAxisTitle,
                  color: "#000",
                  font: { weight: "bold" },
                },
                ticks: {
                  color: "#000",
                  precision: 0,
                },
                grid: {
                  color: "rgba(0,0,0,0.1)",
                  drawBorder: false,
                },
              },
              x: {
                ticks: {
                  color: "#000",
                },
                grid: {
                  color: "rgba(0,0,0,0.05)",
                  drawBorder: false,
                },
              },
            },
            plugins: {
              legend: {
                display: false,
                labels: { color: "#000" },
              },
              tooltip: {
                backgroundColor: "#fff",
                titleColor: "#000",
                bodyColor: "#000",
                borderColor: "rgba(0,0,0,0.15)",
                borderWidth: 1,
                padding: 12,
                usePointStyle: true,
                callbacks: {
                  label: function (context) {
                    return `${context.dataset.label}: ${context.raw}`;
                  },
                },
              },
            },
            elements: {
              line: { cubicInterpolationMode: "monotone" },
            },
          };
        }
      });
    </script>
  </body>
</html>
