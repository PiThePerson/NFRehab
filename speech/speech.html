<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Speech Improvement Therapy</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../css/pts.css" />
    <link rel="stylesheet" href="../css/speech.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <style>
      /* Add language toggle styles */
      .language-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #ffffff;
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 0.9rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 100;
        font-weight: 600;
      }

      /* Improved word highlighting */
      .word.active {
        background-color: #4caf50;
        color: white;
        padding: 2px 4px;
        border-radius: 4px;
        font-weight: bold;
      }

      .word.correct {
        color: #4caf50;
        font-weight: bold;
      }

      .word.incorrect {
        color: #f44336;
        text-decoration: underline;
      }

      /* Dashboard styling - floating left overlay */
      .dashboard-overlay {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
        border-radius: 10px;
        padding: 15px;
        color: white;
        display: flex;
        flex-direction: column;
        gap: 10px;
        backdrop-filter: blur(5px); /* Frosted glass effect */
      }

      .dashboard-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .back-button {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
      }

      .star-display {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <!-- Language Toggle Button -->
    <button class="language-toggle" id="languageToggle">‡πÑ‡∏ó‡∏¢ / EN</button>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DASHBOARD OVERLAY (left side) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="dashboard-overlay">
      <div class="dashboard-item">
        <a href="/dashboard.html" class="back-button">
          <i class="fas fa-arrow-left"></i>
          <span class="translatable" data-key="backToDashboard"
            >Back to Dashboard</span
          >
        </a>
      </div>
      <div class="dashboard-item star-display" id="starCount">
        <i class="fas fa-star"></i>
        <span id="starBalance">0</span> Stars
      </div>
    </div>

    <div class="speech-container">
      <h1 class="therapy-title translatable" data-key="therapyTitle">
        Speech Improvement Therapy
      </h1>

      <div class="therapy-card">
        <!-- Rest of your existing content remains exactly the same -->
        <div class="progress-container">
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <span class="progress-text translatable" data-key="sessionProgress"
            >Session Progress:</span
          >
          <span id="progressText">0%</span>
        </div>

        <div class="exercise-container">
          <div class="instructions">
            <h3>
              <i class="fas fa-info-circle"></i>
              <span class="translatable" data-key="instructions"
                >Instructions</span
              >
            </h3>
            <p class="translatable" data-key="instructionsText">
              Read the highlighted text clearly and accurately. The system will
              highlight words in green as you pronounce them correctly. Words in
              red need improvement. Speak naturally at a comfortable pace.
            </p>
          </div>

          <div class="text-display" id="textDisplay">
            <!-- Text will be inserted here by JavaScript -->
          </div>

          <div class="controls">
            <button id="startBtn" class="therapy-btn">
              <i class="fas fa-microphone mic-icon"></i>
              <span class="translatable" data-key="startRecording"
                >Start Recording</span
              >
            </button>
            <button id="retryBtn" class="therapy-btn" disabled>
              <i class="fas fa-redo"></i>
              <span class="translatable" data-key="tryAgain">Try Again</span>
            </button>
            <button id="nextBtn" class="therapy-btn" disabled>
              <i class="fas fa-forward"></i>
              <span class="translatable" data-key="nextExercise"
                >Next Exercise</span
              >
            </button>
          </div>

          <div class="feedback">
            <h3>
              <i class="fas fa-comment-dots"></i>
              <span class="translatable" data-key="feedback">Feedback</span>
            </h3>
            <div
              id="feedbackText"
              class="translatable"
              data-key="initialFeedback"
            >
              Press "Start Recording" and read the text aloud when ready.
            </div>
            <div class="accuracy-display">
              <span class="translatable" data-key="accuracy">Accuracy:</span>
              <span id="accuracyValue">0%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rest of your JavaScript remains exactly the same -->
    <script>
      /* ===== LANGUAGE TOGGLE FUNCTIONALITY ===== */
      const translations = {
        en: {
          backToDashboard: "Back to Dashboard",
          stars: "Stars",
          therapyTitle: "Speech Improvement Therapy",
          sessionProgress: "Session Progress",
          instructions: "Instructions",
          instructionsText:
            "Read the highlighted text clearly and accurately. The system will highlight words in green as you pronounce them correctly. Words in red need improvement. Speak naturally at a comfortable pace.",
          startRecording: "Start Recording",
          stopRecording: "Stop Recording",
          tryAgain: "Try Again",
          nextExercise: "Next Exercise",
          feedback: "Feedback",
          initialFeedback:
            'Press "Start Recording" and read the text aloud when ready.',
          accuracy: "Accuracy",
          listening: "Listening... Speak clearly and naturally.",
          perfect: "Perfect! Your pronunciation was excellent!",
          greatJob: "Great job! Your pronunciation was very good.",
          goodEffort: "Good effort! Keep practicing to improve further.",
          keepTrying: "Keep trying! Focus on clear pronunciation of each word.",
          congratulations: "Congratulations! ÔøΩ",
          completedAll:
            "You've completed all exercises with {stars} stars earned!",
          startOver: "Start Over",
          browserNotSupported:
            "Speech recognition is not supported in your browser. Please try Chrome or Edge.",
          recognitionError: "Error: {error}. Try again.",
        },
        th: {
          backToDashboard: "‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î",
          stars: "‡∏î‡∏≤‡∏ß",
          therapyTitle: "‡∏ù‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢",
          sessionProgress: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤",
          instructions: "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥",
          instructionsText:
            "‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏Ñ‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ‡∏û‡∏π‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏ö‡∏≤‡∏¢",
          startRecording: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
          stopRecording: "‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
          tryAgain: "‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
          nextExercise: "‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
          feedback: "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞",
          initialFeedback: '‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" ‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á ‡πÜ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°',
          accuracy: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥",
          listening: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á... ‡∏û‡∏π‡∏î‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥",
          perfect: "‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡∏µ‡∏°‡∏≤‡∏Å!",
          greatJob: "‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ! ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡∏µ‡∏°‡∏≤‡∏Å",
          goodEffort: "‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ! ‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á",
          keepTrying: "‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ! ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô",
          congratulations: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! üéâ",
          completedAll:
            "‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏î‡πâ‡∏î‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {stars} ‡∏î‡∏≤‡∏ß!",
          startOver: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà",
          browserNotSupported:
            "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏à‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Chrome ‡∏´‡∏£‡∏∑‡∏≠ Edge",
          recognitionError: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {error} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
        },
      };

      // Speech therapy exercises in English and Thai - Simplified for Thai
      const exercises = {
        en: [
          {
            text: "The sun shines brightly in the clear blue sky.",
            difficulty: 1,
          },
          {
            text: "She sells seashells by the seashore on sunny Sundays.",
            difficulty: 2,
          },
          {
            text: "Peter Piper picked a peck of pickled peppers. How many pickled peppers did Peter Piper pick?",
            difficulty: 3,
          },
          {
            text: "The unique New York view from the huge museum amused the enthusiastic tourists.",
            difficulty: 4,
          },
          {
            text: "Six slippery snails slid slowly seaward while several silver ships sailed silently nearby.",
            difficulty: 5,
          },
        ],
        th: [
          {
            text: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏â‡∏±‡∏ô ‡πÑ‡∏õ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
            difficulty: 1,
          },
          {
            text: "‡πÅ‡∏°‡πà ‡∏ó‡∏≥ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏≠‡∏£‡πà‡∏≠‡∏¢ ‡∏ó‡∏µ‡πà ‡∏ö‡πâ‡∏≤‡∏ô",
            difficulty: 1,
          },
          {
            text: "‡∏õ‡∏•‡∏≤ ‡∏ß‡πà‡∏≤‡∏¢ ‡∏ô‡πâ‡∏≥ ‡πÉ‡∏ô ‡∏™‡∏£‡∏∞",
            difficulty: 2,
          },
          {
            text: "‡∏ô‡∏Å ‡∏ö‡∏¥‡∏ô ‡∏≠‡∏¢‡∏π‡πà ‡∏ö‡∏ô ‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤ ‡∏™‡∏µ ‡∏ü‡πâ‡∏≤",
            difficulty: 2,
          },
          {
            text: "‡∏õ‡∏•‡∏≤‡∏ï‡∏≤‡∏Å‡∏•‡∏°‡∏Å‡∏•‡∏¥‡πâ‡∏á‡∏Å‡∏•‡∏≠‡∏Å ‡∏ï‡∏≤‡∏Å‡∏•‡∏°‡∏Å‡∏•‡∏¥‡πâ‡∏á‡∏Å‡∏•‡∏≠‡∏Å‡∏õ‡∏•‡∏≤",
            difficulty: 3,
          },
          {
            text: "‡∏¢‡∏≤‡∏¢‡∏Å‡∏¥‡∏ô‡∏•‡∏≥‡πÑ‡∏¢ ‡πÑ‡∏¢‡∏Å‡∏¥‡∏ô‡∏•‡∏≥‡πÉ‡∏¢ ‡∏¢‡∏≤‡∏¢‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏¢‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà",
            difficulty: 4,
          },
          {
            text: "‡πÄ‡∏≠‡∏≤‡∏´‡∏π‡∏´‡∏°‡∏µ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏π‡∏´‡∏°‡∏π ‡πÄ‡∏≠‡∏≤‡∏´‡∏π‡∏´‡∏ô‡∏π‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏´‡∏π‡∏´‡∏°‡∏µ ‡∏´‡∏π‡∏´‡∏°‡∏π‡∏´‡∏π‡∏´‡∏°‡∏µ",
            difficulty: 5,
          },
        ],
      };

      // DOM elements
      const elements = {
        textDisplay: document.getElementById("textDisplay"),
        startBtn: document.getElementById("startBtn"),
        retryBtn: document.getElementById("retryBtn"),
        nextBtn: document.getElementById("nextBtn"),
        feedbackText: document.getElementById("feedbackText"),
        accuracyValue: document.getElementById("accuracyValue"),
        progressBar: document.getElementById("progressBar"),
        progressText: document.getElementById("progressText"),
        starBalance: document.getElementById("starBalance"),
        micIcon: document.querySelector(".mic-icon"),
        languageToggle: document.getElementById("languageToggle"),
      };

      // App state
      const state = {
        currentExercise: 0,
        isRecording: false,
        recognition: null,
        stars: localStorage.getItem("stars")
          ? parseInt(localStorage.getItem("stars"))
          : 0,
        speechSynthesis: window.speechSynthesis,
        currentWordIndex: 0,
        correctWords: 0,
        totalWords: 0,
        currentLanguage: localStorage.getItem("nf_language") || "en",
        exercises: exercises.en, // Default to English exercises
      };

      // Function to change language
      function changeLanguage(lang) {
        // Update html lang attribute
        document.documentElement.lang = lang;
        state.currentLanguage = lang;
        state.exercises = exercises[lang];

        // Update all translatable elements
        document.querySelectorAll(".translatable").forEach((element) => {
          const key = element.getAttribute("data-key");
          if (translations[lang] && translations[lang][key]) {
            if (key === "completedAll") {
              element.textContent = translations[lang][key].replace(
                "{stars}",
                state.stars
              );
            } else if (key === "initialFeedback" && state.isRecording) {
              // Don't change feedback text if recording is in progress
            } else {
              element.textContent = translations[lang][key];
            }
          }
        });

        // Update button texts if recording
        if (state.isRecording) {
          elements.startBtn.innerHTML = `<i class="fas fa-microphone-slash mic-icon pulse"></i> ${translations[lang].stopRecording}`;
        }

        // Save language preference
        localStorage.setItem("nf_language", lang);

        // Reload current exercise with new language
        state.currentExercise = 0;
        loadExercise(state.currentExercise);
      }

      // Initialize the app
      function init() {
        // Set initial language
        changeLanguage(state.currentLanguage);
        elements.languageToggle.textContent =
          state.currentLanguage === "en" ? "‡πÑ‡∏ó‡∏¢ / EN" : "TH / English";

        elements.starBalance.textContent = state.stars;
        loadExercise(state.currentExercise);

        // Check for speech recognition support
        if (
          !("webkitSpeechRecognition" in window) &&
          !("SpeechRecognition" in window)
        ) {
          elements.feedbackText.textContent =
            translations[state.currentLanguage].browserNotSupported;
          elements.startBtn.disabled = true;
          return;
        }

        // Initialize speech recognition with Thai language support
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        state.recognition = new SpeechRecognition();
        state.recognition.continuous = true;
        state.recognition.interimResults = true;
        state.recognition.maxAlternatives = 3;

        // Set language based on current selection
        state.recognition.lang =
          state.currentLanguage === "th" ? "th-TH" : "en-US";

        state.recognition.onresult = handleRecognitionResult;
        state.recognition.onerror = handleRecognitionError;
        state.recognition.onend = handleRecognitionEnd;

        // Button event listeners
        elements.startBtn.addEventListener("click", toggleRecording);
        elements.retryBtn.addEventListener("click", retryExercise);
        elements.nextBtn.addEventListener("click", nextExercise);
        elements.languageToggle.addEventListener("click", toggleLanguage);
      }

      // Toggle between English and Thai
      function toggleLanguage() {
        const newLang = state.currentLanguage === "en" ? "th" : "en";
        changeLanguage(newLang);
        this.textContent = newLang === "en" ? "‡πÑ‡∏ó‡∏¢ / EN" : "TH / English";

        // Update recognition language
        if (state.recognition) {
          state.recognition.lang = newLang === "th" ? "th-TH" : "en-US";
        }
      }

      // Load an exercise
      function loadExercise(index) {
        if (index >= state.exercises.length) {
          elements.textDisplay.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <h3 style="color: var(--primary-color); margin-bottom: 1rem;">${
                translations[state.currentLanguage].congratulations
              }</h3>
              <p>${translations[state.currentLanguage].completedAll.replace(
                "{stars}",
                state.stars
              )}</p>
              <button onclick="location.reload()" class="therapy-btn" style="margin-top: 1rem;">
                <i class="fas fa-sync-alt"></i> ${
                  translations[state.currentLanguage].startOver
                }
              </button>
            </div>
          `;
          elements.startBtn.disabled = true;
          elements.retryBtn.disabled = true;
          elements.nextBtn.disabled = true;
          createConfetti();
          return;
        }

        const exercise = state.exercises[index];
        // Split by spaces for English, by character for Thai
        const words =
          state.currentLanguage === "th"
            ? exercise.text
                .split(/(\s+)/)
                .filter((word) => word.trim().length > 0)
            : exercise.text.split(" ");

        state.totalWords = words.length;
        state.correctWords = 0;
        state.currentWordIndex = 0;
        elements.textDisplay.innerHTML = "";

        words.forEach((word, i) => {
          const span = document.createElement("span");
          span.textContent =
            word +
            (state.currentLanguage === "th" && i < words.length - 1 ? " " : "");
          span.className = "word";
          span.dataset.index = i;
          elements.textDisplay.appendChild(span);
        });

        // Highlight the first word
        highlightCurrentWord();

        updateProgress();
        resetFeedback();
      }

      // Toggle recording
      function toggleRecording() {
        if (state.isRecording) {
          stopRecording();
        } else {
          startRecording();
        }
      }

      function startRecording() {
        state.isRecording = true;
        // Set recognition language before starting
        state.recognition.lang =
          state.currentLanguage === "th" ? "th-TH" : "en-US";
        state.recognition.start();
        elements.startBtn.innerHTML = `<i class="fas fa-microphone-slash mic-icon pulse"></i> ${
          translations[state.currentLanguage].stopRecording
        }`;
        elements.feedbackText.textContent =
          translations[state.currentLanguage].listening;
        elements.retryBtn.disabled = true;
        elements.nextBtn.disabled = true;
        resetWordHighlights();
        state.currentWordIndex = 0;
        state.correctWords = 0;
        highlightCurrentWord();
      }

      function stopRecording() {
        state.isRecording = false;
        state.recognition.stop();
        elements.startBtn.innerHTML = `<i class="fas fa-microphone mic-icon"></i> ${
          translations[state.currentLanguage].startRecording
        }`;
        elements.micIcon.classList.remove("pulse");
        elements.retryBtn.disabled = false;
      }

      // Handle recognition results
      function handleRecognitionResult(event) {
        const results = event.results;
        const currentResult = results[results.length - 1];
        const transcript = currentResult[0].transcript.trim();

        const currentWordSpan = elements.textDisplay.querySelector(
          `.word[data-index="${state.currentWordIndex}"]`
        );
        const currentWord = currentWordSpan.textContent.trim();

        // Improved word matching with tolerance for similar sounds
        const isMatch = checkWordMatch(
          transcript,
          currentWord,
          state.currentLanguage
        );

        if (isMatch) {
          currentWordSpan.classList.add("correct");
          currentWordSpan.classList.remove("incorrect", "active");
          state.correctWords++;

          // Move to next word
          state.currentWordIndex++;

          if (state.currentWordIndex < state.totalWords) {
            highlightCurrentWord();
          } else {
            // Exercise complete
            stopRecording();
            const accuracy = Math.round(
              (state.correctWords / state.totalWords) * 100
            );
            handleExerciseCompletion(accuracy);
          }
        } else if (currentResult.isFinal) {
          // Only mark incorrect on final results to avoid false negatives
          currentWordSpan.classList.add("incorrect");
        }
      }

      // Check word matching with language-specific rules
      function checkWordMatch(transcript, targetWord, language) {
        // For Thai, we need exact matches or common mispronunciations
        if (language === "th") {
          // Remove spaces and compare
          const cleanTranscript = transcript.replace(/\s+/g, "");
          const cleanTarget = targetWord.replace(/\s+/g, "");

          // Exact match
          if (cleanTranscript === cleanTarget) return true;

          // Common Thai mispronunciations mapping
          const thaiSimilarMap = {
            ‡∏õ‡∏•‡∏≤: ["‡∏õ‡∏≤", "‡∏õ‡∏•‡∏∞"],
            ‡∏ß‡πà‡∏≤‡∏¢: ["‡∏ß‡∏≤‡∏¢"],
            ‡∏ô‡πâ‡∏≥: ["‡∏ô‡πâ‡∏≤‡∏°"],
            ‡∏™‡∏£‡∏∞: ["‡∏™‡∏∞", "‡∏™‡∏≤"],
            ‡∏ô‡∏Å: ["‡∏ô‡∏≠‡∏Å"],
            ‡∏ü‡πâ‡∏≤: ["‡∏ü‡πà‡∏≤‡∏°"],
          };

          if (thaiSimilarMap[cleanTarget]) {
            return thaiSimilarMap[cleanTarget].includes(cleanTranscript);
          }

          // Check first character match for single character words
          if (cleanTarget.length === 1) {
            return cleanTranscript[0] === cleanTarget[0];
          }

          return false;
        }

        // English matching logic (original)
        if (transcript.toLowerCase().includes(targetWord.toLowerCase())) {
          return true;
        }

        const similarWords = {
          sky: ["skai", "skie", "skye", "sci"],
          the: ["da", "duh"],
          she: ["see", "sha"],
        };

        if (similarWords[targetWord.toLowerCase()]) {
          return similarWords[targetWord.toLowerCase()].some((alt) =>
            transcript.toLowerCase().includes(alt)
          );
        }

        // Phonetic similarity check
        const firstThreeTarget = targetWord.substring(0, 3).toLowerCase();
        const firstThreeTranscript = transcript.substring(0, 3).toLowerCase();
        return firstThreeTarget === firstThreeTranscript;
      }

      function handleRecognitionError(event) {
        console.error("Recognition error:", event.error);
        elements.feedbackText.textContent = translations[
          state.currentLanguage
        ].recognitionError.replace("{error}", event.error);
        stopRecording();
      }

      function handleRecognitionEnd() {
        if (state.isRecording) {
          // Automatically restart if we're still supposed to be recording
          state.recognition.start();
        }
      }

      // Highlight the current word that should be spoken
      function highlightCurrentWord() {
        // Remove active class from all words
        const allWords = elements.textDisplay.querySelectorAll(".word");
        allWords.forEach((word) => word.classList.remove("active"));

        // Add active class to current word
        if (state.currentWordIndex < state.totalWords) {
          const currentWord = elements.textDisplay.querySelector(
            `.word[data-index="${state.currentWordIndex}"]`
          );
          currentWord.classList.add("active");
        }
      }

      // Handle exercise completion
      function handleExerciseCompletion(accuracy) {
        elements.accuracyValue.textContent = `${accuracy}%`;

        if (accuracy >= 90) {
          elements.feedbackText.textContent =
            translations[state.currentLanguage].perfect;
          awardStars(5);
        } else if (accuracy >= 75) {
          elements.feedbackText.textContent =
            translations[state.currentLanguage].greatJob;
          awardStars(4);
        } else if (accuracy >= 50) {
          elements.feedbackText.textContent =
            translations[state.currentLanguage].goodEffort;
          awardStars(3);
        } else {
          elements.feedbackText.textContent =
            translations[state.currentLanguage].keepTrying;
          awardStars(1);
        }

        // Enable next button if accuracy is decent
        if (accuracy >= 50) {
          elements.nextBtn.disabled = false;
        }

        // Speak feedback if speech synthesis is available
        if (state.speechSynthesis) {
          const utterance = new SpeechSynthesisUtterance(
            elements.feedbackText.textContent
          );
          // Set Thai voice if available
          if (state.currentLanguage === "th") {
            const thaiVoice = speechSynthesis
              .getVoices()
              .find((voice) => voice.lang === "th-TH" || voice.lang === "th");
            if (thaiVoice) utterance.voice = thaiVoice;
          }
          state.speechSynthesis.speak(utterance);
        }
      }

      // Reset word highlights
      function resetWordHighlights() {
        const words = elements.textDisplay.querySelectorAll(".word");
        words.forEach((word) => {
          word.classList.remove("correct", "incorrect", "active");
        });
      }

      // Move to next exercise
      function nextExercise() {
        state.currentExercise++;
        loadExercise(state.currentExercise);
        elements.nextBtn.disabled = true;
        elements.retryBtn.disabled = true;
      }

      // Retry current exercise
      function retryExercise() {
        loadExercise(state.currentExercise);
        elements.nextBtn.disabled = true;
        elements.retryBtn.disabled = true;
      }

      // Reset feedback display
      function resetFeedback() {
        elements.accuracyValue.textContent = "0%";
        elements.feedbackText.textContent =
          translations[state.currentLanguage].initialFeedback;
      }

      // Update progress bar
      function updateProgress() {
        const progress = (state.currentExercise / state.exercises.length) * 100;
        elements.progressBar.style.width = `${progress}%`;
        elements.progressText.textContent = `${Math.round(progress)}%`;
      }

      // Award stars for completion
      function awardStars(amount) {
        state.stars += amount;
        elements.starBalance.textContent = state.stars;
        localStorage.setItem("stars", state.stars.toString());
        createConfetti();
      }

      // Create celebration confetti
      function createConfetti() {
        const colors = ["#4CAF50", "#2196F3", "#FFEB3B", "#FF5722", "#9C27B0"];

        for (let i = 0; i < 50; i++) {
          const confetti = document.createElement("div");
          confetti.className = "confetti";
          confetti.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];
          confetti.style.left = `${Math.random() * 100}vw`;
          confetti.style.top = "-10px";
          confetti.style.width = `${Math.random() * 10 + 5}px`;
          confetti.style.height = `${Math.random() * 10 + 5}px`;
          confetti.style.opacity = Math.random() + 0.5;

          document.body.appendChild(confetti);

          const animationDuration = Math.random() * 3 + 2;
          confetti.style.animation = `fall ${animationDuration}s linear forwards`;

          // Create keyframes for falling animation
          const keyframes = `
            @keyframes fall {
              to {
                transform: translateY(100vh) rotate(${Math.random() * 360}deg);
                left: ${Math.random() * 100}vw;
              }
            }
          `;

          const styleEl = document.createElement("style");
          styleEl.innerHTML = keyframes;
          document.head.appendChild(styleEl);

          // Remove confetti after animation
          setTimeout(() => {
            confetti.remove();
            styleEl.remove();
          }, animationDuration * 1000);
        }
      }

      // Initialize the app when voices are loaded
      window.speechSynthesis.onvoiceschanged = function () {
        init();
      };

      // Also initialize if voices are already loaded
      if (window.speechSynthesis.getVoices().length > 0) {
        init();
      } else {
        // Fallback in case voiceschanged doesn't fire
        setTimeout(init, 1000);
      }
    </script>
  </body>
</html>
